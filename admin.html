<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RebuyOps – Admin Panel</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230f172a'/%3E%3Ctext x='50%25' y='53%25' dominant-baseline='middle' text-anchor='middle' font-family='Inter,sans-serif' font-weight='800' font-size='20' fill='white'%3ER%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ── Reset ──────────────────────────────────────────── */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #111111;
            background: #f5f5f5;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        button {
            cursor: pointer;
            font-family: inherit;
        }

        input,
        select {
            font-family: inherit;
        }

        /* ── Auth Screen ────────────────────────────────────── */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 24px;
        }

        .auth-card {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 48px 40px;
            width: 100%;
            max-width: 400px;
        }

        .auth-logo {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: #0f172a;
            text-align: center;
            margin-bottom: 4px;
        }

        .auth-sub {
            text-align: center;
            font-size: 0.875rem;
            color: #888888;
            margin-bottom: 36px;
        }

        .auth-group {
            margin-bottom: 18px;
        }

        .auth-group label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333333;
        }

        .auth-group input {
            width: 100%;
            padding: 11px 14px;
            font-size: 0.9375rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #ffffff;
            color: #111111;
            transition: border-color 0.2s;
        }

        .auth-group input:focus {
            outline: none;
            border-color: #0f172a;
        }

        .auth-error {
            display: none;
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.8125rem;
            margin-bottom: 18px;
        }

        .btn {
            display: inline-block;
            background: #0f172a;
            color: #ffffff;
            font-size: 0.9375rem;
            font-weight: 600;
            padding: 12px 28px;
            border: none;
            border-radius: 6px;
            transition: background 0.2s;
            letter-spacing: 0.01em;
        }

        .btn:hover {
            background: #1e293b;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-full {
            width: 100%;
        }

        /* ── Dashboard ──────────────────────────────────────── */
        .dashboard {
            display: none;
        }

        /* Top Bar */
        .topbar {
            background: #0f172a;
            color: #ffffff;
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-brand {
            font-size: 1.125rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .topbar-user {
            font-size: 0.8125rem;
            color: #94a3b8;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 0.8125rem;
            font-weight: 500;
            padding: 6px 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 5px;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Content */
        .dash-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 28px 24px;
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            padding: 24px 28px;
        }

        .stat-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #888888;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: -0.02em;
        }

        /* Controls */
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #ffffff;
            color: #111111;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #0f172a;
        }

        .filter-select {
            padding: 10px 36px 10px 14px;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #ffffff;
            color: #111111;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23555' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .filter-select:focus {
            outline: none;
            border-color: #0f172a;
        }

        .btn-refresh {
            background: #ffffff;
            color: #0f172a;
            border: 1px solid #d1d5db;
            padding: 10px 18px;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 6px;
            transition: background 0.2s, border-color 0.2s;
        }

        .btn-refresh:hover {
            border-color: #0f172a;
        }

        /* Table */
        .table-wrap {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            overflow: hidden;
        }

        .table-scroll {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        thead {
            background: #f9fafb;
            border-bottom: 1px solid #e5e5e5;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #555555;
            white-space: nowrap;
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid #f0f0f0;
            color: #333333;
            white-space: nowrap;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Status Badge */
        .badge {
            display: inline-block;
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .badge-new {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .badge-contacted {
            background: #fef3c7;
            color: #b45309;
        }

        .badge-closed {
            background: #d1fae5;
            color: #047857;
        }

        /* Status Dropdown */
        .status-select {
            font-size: 0.8125rem;
            padding: 5px 28px 5px 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            background: #ffffff;
            color: #111111;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23555' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            cursor: pointer;
        }

        .status-select:focus {
            outline: none;
            border-color: #0f172a;
        }

        /* Detail Row */
        .detail-row td {
            padding: 0;
            background: #f9fafb;
        }

        .detail-content {
            padding: 20px 24px;
            font-size: 0.875rem;
            line-height: 1.8;
            color: #333333;
        }

        .detail-content strong {
            color: #111111;
            font-weight: 600;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px 32px;
        }

        /* Empty/Loading state */
        .table-empty {
            text-align: center;
            padding: 60px 20px;
            color: #888888;
            font-size: 0.9375rem;
        }

        .table-loading {
            text-align: center;
            padding: 60px 20px;
            color: #888888;
            font-size: 0.9375rem;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #111111;
            color: #ffffff;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 0.875rem;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            max-width: 90vw;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            background: #dc2626;
        }

        .toast.success {
            background: #059669;
        }

        /* ── Responsive ─────────────────────────────────────── */
        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                min-width: auto;
            }

            .topbar-user {
                display: none;
            }

            .auth-card {
                padding: 36px 24px;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- ───── LOGIN SCREEN ───── -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-card">
            <div class="auth-logo">RebuyOps</div>
            <p class="auth-sub">Admin Panel</p>
            <div class="auth-error" id="authError"></div>
            <form id="loginForm">
                <div class="auth-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="admin@rebuyops.com" required>
                </div>
                <div class="auth-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn btn-full" id="loginBtn">Sign In</button>
            </form>
        </div>
    </div>

    <!-- ───── DASHBOARD ───── -->
    <div class="dashboard" id="dashboard">

        <!-- Top Bar -->
        <div class="topbar">
            <span class="topbar-brand">RebuyOps Admin</span>
            <div class="topbar-right">
                <span class="topbar-user" id="adminEmail"></span>
                <button class="btn-logout" id="logoutBtn">Logout</button>
            </div>
        </div>

        <div class="dash-content">

            <!-- Stats -->
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-label">Total Requests</div>
                    <div class="stat-value" id="statTotal">–</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">New (Unread)</div>
                    <div class="stat-value" id="statNew">–</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Today</div>
                    <div class="stat-value" id="statToday">–</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <input type="text" class="search-input" id="searchInput" placeholder="Search by name, brand, or email…">
                <select class="filter-select" id="filterStatus">
                    <option value="all">All Statuses</option>
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="closed">Closed</option>
                </select>
                <button class="btn-refresh" id="refreshBtn">↻ Refresh</button>
            </div>

            <!-- Table -->
            <div class="table-wrap">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Brand</th>
                                <th>Website</th>
                                <th>Revenue</th>
                                <th>Email</th>
                                <th>WhatsApp</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="8" class="table-loading">Loading…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- ───── JS ───── -->
    <script type="module">
        import { db, auth } from './firebase-config.js';
        import {
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js';
        import {
            collection,
            query,
            orderBy,
            onSnapshot,
            doc,
            updateDoc
        } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

        // ── DOM refs ──
        const authScreen = document.getElementById('authScreen');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const authError = document.getElementById('authError');
        const adminEmailEl = document.getElementById('adminEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const tableBody = document.getElementById('tableBody');
        const searchInput = document.getElementById('searchInput');
        const filterStatus = document.getElementById('filterStatus');
        const refreshBtn = document.getElementById('refreshBtn');
        const statTotal = document.getElementById('statTotal');
        const statNew = document.getElementById('statNew');
        const statToday = document.getElementById('statToday');
        const toastEl = document.getElementById('toast');

        let allRequests = [];
        let unsubscribe = null;

        // ── Toast ──
        function showToast(msg, type) {
            toastEl.textContent = msg;
            toastEl.className = 'toast show' + (type ? ' ' + type : '');
            setTimeout(() => { toastEl.className = 'toast'; }, 3500);
        }

        // ── Auth State ──
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authScreen.style.display = 'none';
                dashboard.style.display = 'block';
                adminEmailEl.textContent = user.email;
                loadData();
            } else {
                authScreen.style.display = 'flex';
                dashboard.style.display = 'none';
                if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            }
        });

        // ── Login ──
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.style.display = 'none';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in…';
            try {
                await signInWithEmailAndPassword(
                    auth,
                    document.getElementById('loginEmail').value.trim(),
                    document.getElementById('loginPassword').value
                );
            } catch (err) {
                authError.textContent = getAuthErrorMessage(err.code);
                authError.style.display = 'block';
            }
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign In';
        });

        function getAuthErrorMessage(code) {
            switch (code) {
                case 'auth/invalid-credential':
                case 'auth/wrong-password':
                case 'auth/user-not-found':
                    return 'Invalid email or password.';
                case 'auth/too-many-requests':
                    return 'Too many attempts. Please try again later.';
                default:
                    return 'Authentication failed. Please try again.';
            }
        }

        // ── Logout ──
        logoutBtn.addEventListener('click', () => signOut(auth));

        // ── Load Data (real-time) ──
        function loadData() {
            const q = query(collection(db, 'audit_requests'), orderBy('createdAt', 'desc'));
            unsubscribe = onSnapshot(q, (snapshot) => {
                allRequests = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateStats();
                renderTable();
            }, (err) => {
                console.error('Firestore read failed:', err);
                showToast('Failed to load data.', 'error');
            });
        }

        // ── Stats ──
        function updateStats() {
            statTotal.textContent = allRequests.length;
            statNew.textContent = allRequests.filter(r => r.status === 'new').length;

            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            const todayTs = todayStart.getTime();
            statToday.textContent = allRequests.filter(r => {
                if (!r.createdAt) return false;
                const ts = r.createdAt.toDate ? r.createdAt.toDate().getTime() : 0;
                return ts >= todayTs;
            }).length;
        }

        // ── Render Table ──
        function renderTable() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const statusFilter = filterStatus.value;

            let filtered = allRequests;

            if (statusFilter !== 'all') {
                filtered = filtered.filter(r => r.status === statusFilter);
            }

            if (searchTerm) {
                filtered = filtered.filter(r =>
                    (r.fullName || '').toLowerCase().includes(searchTerm) ||
                    (r.brandName || '').toLowerCase().includes(searchTerm) ||
                    (r.email || '').toLowerCase().includes(searchTerm)
                );
            }

            if (filtered.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="table-empty">No requests found.</td></tr>';
                return;
            }

            tableBody.innerHTML = filtered.map(r => {
                const date = r.createdAt && r.createdAt.toDate
                    ? r.createdAt.toDate().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })
                    : '–';
                const time = r.createdAt && r.createdAt.toDate
                    ? r.createdAt.toDate().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })
                    : '';
                const status = r.status || 'new';
                const badgeClass = 'badge badge-' + status;

                return `
          <tr class="data-row" data-id="${r.id}">
            <td>${date}</td>
            <td>${esc(r.fullName)}</td>
            <td>${esc(r.brandName)}</td>
            <td><a href="${esc(r.websiteUrl)}" target="_blank" rel="noopener" style="color:#0f172a;text-decoration:underline">${esc(r.websiteUrl)}</a></td>
            <td>${esc(r.revenue)}</td>
            <td><a href="mailto:${esc(r.email)}" style="color:#0f172a">${esc(r.email)}</a></td>
            <td><a href="https://wa.me/${esc((r.whatsapp || '').replace(/[^0-9]/g, ''))}" target="_blank" rel="noopener" style="color:#0f172a">${esc(r.whatsapp)}</a></td>
            <td>
              <select class="status-select" data-id="${r.id}" onchange="window.__updateStatus(this)">
                <option value="new" ${status === 'new' ? 'selected' : ''}>New</option>
                <option value="contacted" ${status === 'contacted' ? 'selected' : ''}>Contacted</option>
                <option value="closed" ${status === 'closed' ? 'selected' : ''}>Closed</option>
              </select>
            </td>
          </tr>
          <tr class="detail-row" data-detail="${r.id}" style="display:none">
            <td colspan="8">
              <div class="detail-content">
                <div class="detail-grid">
                  <div><strong>Full Name:</strong> ${esc(r.fullName)}</div>
                  <div><strong>Brand:</strong> ${esc(r.brandName)}</div>
                  <div><strong>Website:</strong> <a href="${esc(r.websiteUrl)}" target="_blank" rel="noopener">${esc(r.websiteUrl)}</a></div>
                  <div><strong>Revenue:</strong> ${esc(r.revenue)}</div>
                  <div><strong>Email:</strong> <a href="mailto:${esc(r.email)}">${esc(r.email)}</a></div>
                  <div><strong>WhatsApp:</strong> ${esc(r.whatsapp)}</div>
                  <div><strong>Submitted:</strong> ${date} ${time}</div>
                  <div><strong>Status:</strong> <span class="${badgeClass}">${status}</span></div>
                </div>
              </div>
            </td>
          </tr>
        `;
            }).join('');

            // Attach row click → expand
            tableBody.querySelectorAll('.data-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (e.target.closest('.status-select')) return;
                    if (e.target.closest('a')) return;
                    const id = row.dataset.id;
                    const detail = tableBody.querySelector(`[data-detail="${id}"]`);
                    if (detail) {
                        detail.style.display = detail.style.display === 'none' ? '' : 'none';
                    }
                });
            });
        }

        // ── Update Status ──
        window.__updateStatus = async function (el) {
            const id = el.dataset.id;
            const newStatus = el.value;
            try {
                await updateDoc(doc(db, 'audit_requests', id), { status: newStatus });
                showToast('Status updated to ' + newStatus, 'success');
            } catch (err) {
                console.error('Status update failed:', err);
                showToast('Failed to update status.', 'error');
            }
        };

        // ── Search & Filter ──
        searchInput.addEventListener('input', renderTable);
        filterStatus.addEventListener('change', renderTable);
        refreshBtn.addEventListener('click', () => {
            showToast('Data is synced in real-time.', '');
        });

        // ── Escape HTML ──
        function esc(str) {
            if (!str) return '–';
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }
    </script>
</body>

</html>